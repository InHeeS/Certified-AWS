# Encryption 

tsl 은 ssl 의 가장 최근 버전입니다. 데이터가 전송되기 전에 암호화되고 받은 후에 해독 되는 것입니다. 

데이터를 암호화하기 위해 tls 인증서가 사용 됩니다. 

목표하는 대상 서버만이 저희가 전송하는 암호화된 데이터를 해독합니다. 

즉 보안이 유지된 상태로 로그인 할 수 있는 것입니다. 

서버 측 암호화는
모든 암호화와 해독이 서버에서 일어나는 것입니다

클라이언트 측 암호화는 암호화된 객체는 어느 스토리지 서비스에든 안전하게 전송 됩니다. 

# aws kms(key management Service)

kms 서비스는 우리를 대신해서 암호화키를 관리한다는 개념입니다. 

ebs 볼륨에 저장되어 있는 데이터를 암호화하고 싶으면 kms 통합을 활성화 합니다. s2,rds, ssm 도 마찬가지 입니다. 

비밀 데이터가 있다면 절대로 평문 텍스트에 저장하면 안됩니다. 즉 그대로 두면 안됩니다. 

두가지 유형이 있ㅅ브니다. 

1. 대칭 kms 키가 있습니다.
   데이터를 암호화하고 복호화하는데 사용되는 암호화 키가 하나만 있다는 의미입니다.

   단지 aws api 호출을 이용해서 그 키를 사용할 뿐입니다.

2. 비대칭 kms 키가 있습니다.
   암호화하는데 사용되는 퍼블릭키, 데이터를 복호화하는 데 사용되는 프라이빗 키

kms 키 안에는 다양한 타입의 kms 키가 있습니다. 

첫번재는 aws가 소유한 키입니다. sse-s3 타입의 암호화를 사용하거나 sse dynamoDB를 사용할 대 사용하는 키입니다. 

다음으로는 aws 관리형 키가 있습니다. aws/가 있고 서비스 이름이 나옵니다. 

마지막으로는 고객 관리형 키가 있습니다. api 호출 건에 대해 지불합니다. 

kms 키의 범위는 리전입니다. 동일한 kms 키가 두 리전에 있을 수 없습니다. 

kms 를 이용해서 그 스냅샷을 원래의 ebs 볼륨으로 복구합니다. 

kms 정책으로는 두가지 유형이 있습니다. 

기본 정책은 여러분이 특정한 커스텀 kms 키 정책을 제공하지 않았을때 생성됩니다. kms 키에 대한 교차 계정 액세스를 하렬 경우 유용합니다. 즉 다른 계정이 우리의 kms 키를 사용하도록 승인할 수 있도록 말입니다. 

*시나리오*

예, 예를 들어 암호화된 스냅샷을 계정들 간에 복사하고 싶을 때 사용해요, 그럼 우린 우리의 고객 관리형 KMS 키로
암호화된 스냅샷을 생성하고요

우린 커스텀 키 정책을 첨부해야 되기 때문에 반드시 고객 관리형 KMS 키가 되어야 하죠, 그리고 우린
교차 계정 액세스를 승인하기 위한 KMS 키 정책을 첨부해요
이런 모습이예요

그리고 우린 암호화된 스냅샷을 타깃 계정과 공유하죠
그리고 타깃 계정 안에서 우린 스냅샷의 사본을 생성하고요, 다른 고객 관리형 키를 사용해서 그 타깃 계정 안에서
그걸 암호화하죠

# kms 다중 리전 키

aws kms 에는 다중 리전 키를 둘 수 있습니다. 
즉, 선택된 한리전에 기본 키를 갖는다는 의미입니다. 키 구성 요소가 복제되기 때문입니다. 

다중 리전 키의 핵심은
한 리전에서 암호화하고 다른 리전에서 복호화해
다음 리전으로 복제할 때나 교차 리전 API 호출을 실행할 때
데이터를 재암호화하지 않아도 된다는 점입니다

하지만 KMS 다중 리전 키는 전역으로 사용할 수 없다는 점을 기억하세요

다중 리전 키의 사용 사례에는
전역 클라이언트 측 암호화가 있습니다
한 리전에서 클라이언트 측 암호화를 하고
다른 리전에서 클라이언트 측 복호화를 하는 거죠

데이터베이스 관리자로부터도 보호할 수 있는 것이죠

DynamoDB 테이블이 전역 테이블인 경우
해당 테이블의 데이터는 다른 리전으로 복제됩니다
ap-southeast-2로 복제되죠

다행히 다중 리전 키로 데이터 속성을 암호화하기로 했기 때문에
ap-southeast-2 리전의 클라이언트 애플리케이션은
열을 검색해서 해당 속성이 암호화됐는지 확인한 후
API 호출을 실행해
복제된 다중 리전 키를 사용해 해당 속성을 복호화합니다
다중 리전 키를 사용하는 이유입니다

Amazon Aurora DB에 액세스할 수 있는 DB 관리자가
'사회 보장 번호' 열에 액세스하고자 할 때
KMS 키에 대한 액세스 권한이 없으면
해당 데이터를 읽을 수 없습니다
아주 유용하죠

# s3 replication encryption considerations 

한 버킷에서 다른 버킷으로 S3 복제를 활성화하면

암호화되지 않은 객체와 SSE-S3로 암호화된 객체가 기본으로 복제됩니다

SSE-KMS로 암호화된 객체도 있습니다
기본적으로 복제되지 않지만
만약 객체를 복제하려면
옵션을 활성화해야 합니다

따라서 어떤 KMS 키로
대상 버킷 내 객체를 암호화하는지 지정해야 합니다
그리고 이 KMS 키 정책을 대상 키에 적용해야 하고
S3 복제 서비스를 허용하는 IAM 역할을 생성해서
소스 버킷의 데이터를 먼저 복호화하도록 한 뒤
대상 KMS 키로 대상 버킷의 데이터를 다시 암호화합니다
이렇게 하면 복제가 활성화되는데
이는 수많은 암호화와 복호화가 발생하기 때문입니다

KMS 스로틀링 오류가 발생한 경우는 서비스 할당량을 요청해야 합니다


# exam

ami 를 다른 계정과 공유하는 과정에 관한 것으로 aim는 kms 키로 암호화 되어 있습니다. 

어떤 방식으로 A 계정의 AMI에서 B 계정의 EC2 인스턴스를 시작할까요?

먼저, 시작 권한으로 AMI 속성을 수정해야 하는데
이 시작 권한은 B 계정에서 AMI를 시작하도록 허용합니다

이렇게 AMI를 공유합니다
시작 권한을 수정하고 특정 대상인 AWS 계정 ID를 추가하는 것이죠

그런 다음 B 계정에서 사용하도록 KMS 키도 공유해야 하므로
일반적으로 키 정책으로 실행됩니다

이제 B 계정에서 KMS 키와 AMI를 모두 사용할 수 있는
충분한 권한을 가진 IAM 역할이나 IAM 사용자를 생성합니다

따라서 DescribeKey API 호출과 ReEncrypted API 호출
CreateGrant, Decrypt API 호출에 관한 KMS 측 액세스 권한이 있어야 합니다

모두 완료된 후에는 AMI에서 EC2 인스턴스를 시작하면 되는데
선택 사항으로 대상 계정에서 자체 계정의 볼륨을 재암호화하는
KMS 키를 이용해 전체를 재암호화할 수 있습니다

# Ssm parameter Store

구성 및 암호를 위한 보안 스토리지 입니다. 

구성을 암호화할시 선택 하므로 kms 서비스를 이용해 암호를 만듭니다. 

서버리스이며 확장성과 내구성이 있고 sdk 도 사용이 용이합니다. 

구성과 암호의 버전을 추적할 수도 있습니다
특정한 경우에는 Amazon EventBridge로 알림을 받을 수도 있어요
CloudFormation과 통합도 됩니다

이렇게 여러분이 원하는 방식으로 매개변수를 구조화할 수 있습니다

Systems Manager에는 두 가지 매개변수 티어가 있는데
바로 표준과 고급입니다
가장 큰 차이는 용량으로 각각 4KB, 8KB입니다

![image](https://github.com/InHeeS/Certified-AWS/assets/105423951/9d76decf-d843-45fd-aebe-1eaa43d19e98)

# aws secrets Manager

ssm parameter store과는 다른 서비스 입니다. 

Secrets Manager는 X일마다 강제로 암호를 교체하는 기능이 있어
암호 관리를 더 효율적으로 할 수 있죠

또한 AWS Secrets Manager로
교체할 암호를 강제 생성 및 자동화할 수 있습니다

AWS가 제공하는 다양한 서비스와도 아주 잘 통합됩니다
Amazon RDS, MySQL PostgreSQL, Aurora 등이 있죠
AWS 외 여러 서비스와 데이터베이스에도 즉시 통합할 수 있어요

*암호는 KMS 서비스를 통해 암호화됩니다
RDS와 Aurora의 통합 혹은 암호에 대한 내용이 시험에 나오면
AWS Secrets Manager를 떠올리세요*

이는 복수 AWS 리전에 암호를 복제할 수 있고
AWS Secrets Manager 서비스가
기본 암호와 동기화된 읽기 전용 복제본을 유지한다는 개념인데요
이렇게 두 리전이 있을 때 기본 리전에 암호를 하나 만들면
보조 리전에 동일한 암호가 복제됩니다

이유로는 다중 리전 앱을 구축하고 재해 복구 전략도 짤 수 있습니다. 


