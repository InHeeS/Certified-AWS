# Container

docker : 앱 배포를 위한 소프트웨어 개발 플랫폼입니다. 사용 사례에는 마이크로서비스 아키텍처가 있습니다. 또한 온프레미스에서 클라우드로 앱을 리프트-앤-시프트 하기도 합니다. 

도커 이지지는 도커 리포지토리에 저장합니다. 

첫번째로는 docker hub 퍼플릭 리포지토리입니다. 

두번째로는 프라이빗 리포지토리인 ecr 이 있습니다. 

도커 역시 순전히 가상화 기술은 아닙니다 한 서버에서 다수의 컨테이너를 공유할 수있습니다. 

ec2와는 다르게 도커는 하나의 서버에 많은 컨테이너를 실행합니다. 
도커를 시작하려면 우선 dockerfile을작성합니다. 컨테이너를 구성하는 파일입니다. 

aws에서 도커 컨테이너를 관히라는 방법은 ecs 입니다. eks 는 kubernates 의 관리형 버전으로 오픈 소스 프로젝트입니다. 

# ecs

aws 에서 컨테이너를 실행하면 ecs클러스터에 이른바 ecs 태스크를 실행합니다. ec2 인스턴스가 들어있습니다. 인프라를 직접 프로비저닝하고 유지해야 합니다. 각각의 ecs 에이전트를 실행해야 합니다. 

두번째 시작 유형은 fargate 시작 유형입니다. 도커 컨테이너를 실행 하며 인프라를 프로비저닝 하지 않아 관리한 ec2 인스턴스가 없습니다. 서버리스입니다. 

서버리스는 서버를 관리하지 않아 서버리스라 부르는데 서버가 없는건 아닙니다. 

ec2 태스크를 정의하는 태스크 정의만 생성하면 aws가 대신 실행합니다. 

--

*ec2 태스크의 iam 역할을 살펴보면 ecs 에이전트만이 ec2 인스턴스 프로파일을 사용하며 ec2 인스턴스 ㅍ로파일을 이용해 api 호출을 합니다. 그렇게 되면 cloudwatch 로그에 api 호출을 해서 컨테이너 로그를 보내고 ecr 로부터 도커 이미지를 가져옵니다.*

*ec2 시작유형을 사용한다면 ec2 인스턴스 프로파일을 생성합니다.*

*s3 는 ecs 태스크에 파일 시스템으로 마운트 될 수 없습니다.*

*efs 를 연결하여 데이터를 공유하고 fargate 로 서비리스 방식ㅇ로 ec2 태스크를 실행하고 파일 시스템 지속성을 위해서는 efs 사용하는 것이 가장 좋습니다.*

# ec2 service auto scaling

auto Scaling 이라는 서비스를 사용하면 ecs task 수를 자동으로 조절합니다. 

ecs 서비스의 cpu 사용률을 확장합니다. 세가지 지표만 기억합니다

*특정 타겟을 추적하는 대상 추적 스케일링이나 단계 스케일링 혹인 미리 ecs 서비스 확장을 설정하는 예약 스케일링등이 있습니다.*

*ec2 시작 유형이라면 태스크 레벨에서의 ecs 서비스 확장이 ec2 인스턴스 클러스터의 확장과 다르다는 것을 기억해야합니다.*

ec2 오토 스케일링이 필요하지 않다면 즉 벡엔드에 ec2 인스턴스가 없다면 fargate를 사용하는 것이 서비스 오토스케일링에 도움이 됩니다. 

ec2 시작 유형에서는 asg 를 이용합니다. 

![image](https://github.com/InHeeS/Certified-AWS/assets/105423951/e019ed88-c8ca-4f8a-b0cd-66dbcf8d4b7f)

# ecs solution architect

amazon eventBridge 는 항상 ecs 태스크를 실행하기 위한 규칙을 갖고 있을 수 있습니다. 이제 ecs 태스크가 생성되고 그 결과를 db로 전송합니다. 

eventBridge 는 최소한 여러분의 ecs 클러스터에 있는 컨테이너들의 라이프 사이클을 이해할 수 있게 해줍니다. 

*section 208*

# ecr

aws에 도커 이미지를 저장하고 관리하는데 사용됩니다.  

두가지 옵션 이있습니다. 

첫 번째는 계정에 한해 이미지를 비공개로 저장하며 여러 계정으로 설정할 수도 있습니다. 

혹은 퍼플릭 저장소를 사용해 amazon ecr public gallery 에 게시하는 방법이 있습니다. 

이미지는 백그라운드에서 s3에 저장됩니다. 

ecs 클러스터의 ec2 인스턴스에 이미지를 끌어오기 위해서는 e2 인스턴스에 iam 역할을 지정하면 됩니다. ecr 에 대한 모든 접근은 iam이 보호하고 있습니다. 

docker hub 의 역할을 대신한다고 생각하면 됩니다. 단순히 저장하는 리포지토리에 그치지 않고 이미지의 취약점 스캐닝, 버저닝 태그 및 수명 주기 확인을 지원합니다. 

*즉 도커 이미지를 저장할 때는 ecr을 기억합니다*

# eks

eks 에 컨테이너를 시작합니다. 관리형 kubernates 클러스터를 실행할 수 있는 서비스 입니다. 

kubernetes 는 docker로 컨테이너화한 애플리케이션의 자동배포 ,확장 , 관리를 지원합니다. 오픈 소스이며 여러 클라우드 제공자가 사용하므로 표준화를 기대 가능합니다. 

eks 의 두가지 모드

1. ec2 시작 모드는 ec2 인스턴스에서 처럼 작업자 모드를 배포

2. fargate 모드는 eks 클러스터에 서버리스 컨테이너를 배포할 때 사용합니다.

사용 사례로는 회사가 온프레미스나 클라우드에서 kubernetes 나 kubernetes api를 사용 줄일때 kubernetes 클러스터를 관리하기 위해 eks 를 사용합니다. 

클라우느 애그노스틱으로 azure, google cloud 등 모든 클라우드에 지원됩니다. 또한 클라우드 또는 컨테이너 간 마이그레이션을 실행하는 경우 eks 가 간단한 솔류션입니다. 

![image](https://github.com/InHeeS/Certified-AWS/assets/105423951/559f8f98-f1f3-4beb-a63d-a649078eae41)

eks 의 노드 유형을 정히해보면 노드는 즉, 인스턴스를 생성하고 관리합니다. 노드는 eks 서비스로 관리되는 asg 의 일부입니다. 

온디맨스, 스팟 인스턴스를 지원합니다 .

사전에 빌드된 aim 인 eks 최적화 ami를 사용하면 시간을 절약합니다. 

eks 가 지원하는 fargate 모드인 경우에는 유지 관리도 필요 없고 노드를 관리하지 않아도 되며 eks에서 컨테이너만 실행하면 됩니다. 

*eks 클러스터에 데이터 볼륨을 연결하려면 클러스터에 스토리지 클래스 매니페스트를 지정해야합니다. 이것은 csl 규격 드라이버를 활요해야합니다.*

*csl 은 ebs 와 fargate 모드가 작동하는 유일한 스토리지 클래스 유형인 efs를 지원하고 fsx for lustre, fsx for ontap를 지원합니다.* 

# app runner 

완전 관리형 서비스로 규모에 따라 웹 애플리케이션 api 배포를 돕습니다.

원하는 구성을 설정합니다. 웹 애플리케이션이나 api에 들어갈 기본 설정을 설정합니다. 다음 작음은 자동으로 이루어 집니다. 

app runner 서비스가 웹 앱을 빌드하고 배포합니다. 컨테이너가 생성되고 배포 되죠 

장점으로는 auto scaling 이 가능하고 가용성이 높으며 로드 밸런싱 및 암호화 기능을 ㅣ줭합니다. 

컨테이너가 vpc에 에 액세스 가능하며 db 와 cache 메시지 대기열 서비스에 연결 가능합니다. 신속한 배포가 필요할 때도 가장좋은 방법입니다. 

![image](https://github.com/InHeeS/Certified-AWS/assets/105423951/67c8a6c7-5c16-40b9-bdfa-9d9ddc5e713f)

# quiz

Question 5:
EC2 인스턴스로 구성된 ECS 클러스터 상에 애플리케이션을 배포하려 합니다. 현재, 클러스터는 DynamoDB에 대한 API 호출을 성공적으로 발행한 애플리케이션 하나를 호스팅하고 있습니다. S3로의 API 호출을 발행하는 두 번째 애플리케이션을 추가하려는데, 권한 부여 관련 문제가 발생했습니다. 이 문제를 해결하고 적절한 보안을 유지하기 위해서는 어떤 방법을 사용해야 할까요?

Answer : 새 애플리케이션을 위한 iam 역할 생성 




