# CloudWatch

aws 의 모든 서브스에 대한 지표를 제공합니다. 

지표당 최대 측정 기준은 30개입니다. 시간을 기반으로 하므로 타임스탬프가 있어야 합니다. 

사용자 지정 지표를 만들 수도 있습니다. 

cloudwatch 지표는 kinesis dataFirehose 로 거의 실시간으로 스트리밍됩니다. 

![image](https://github.com/InHeeS/Certified-AWS/assets/105423951/dc00bdf3-e056-40de-8fe0-0fad084411b7)

cloudWatch의 지표의 장점은 기간을 클릭해 영역을 선택하기만 하면 해당 지표의 세부 데이터가 뜹니다. 

원하는 리전을 기반으로 혹은 측정 기준을 기반으로 지표를 한눈에 볼 수 있습니다. 

# CloudWatch Logs

cloudWatch Logs 를 다양한 대상으로 전송 가능합니다. 

기본값으로 모든 로그가 암호화 되어있습니다. 

원한다면 kms 기반 암호화를 설정가능합니다. 

sdk를 사용하여 로그를 전송 가능합니다. cloudWatch logs Agent 나cloud Watch unified Agent 를 사용할 수 있습니다. 

CloudTrail은
직접 필터에 기반한 로그를 전송할 거고요, Route 53은 서비스에 대한 모든 DNS 쿼리를 로깅합니다. 

그럼 CloudWatch Logs의 로그를 쿼리하려면 어떻게 하면 될까요?
그걸 위해 여러분은 CloudWatch Logs Insights를 이용할 수 있어요, 이건 CloudWatch Logs 안의 쿼리 기능이고요
여러분은 그걸로 쿼리를 작성할 수 있어요
여러분의 쿼리에 적용하려는 시간대를 지정하고, 그럼 자동적으로 결과를
시각적으로 받게 되죠

특정한 IP를 검색할 수도 있고 그 외에도 많은 확인이 가능해요

기억하실 점은 CloudWatch Logs Insights는 실시간 엔진이 아니라 쿼리 엔진이라는 점이예요

![image](https://github.com/InHeeS/Certified-AWS/assets/105423951/e9b1860b-a8bd-4e9b-b8ef-dcf20df59f4f)

Live tail 은 디버깅할 대 도움이 됩니다. 

# CloudWatch Logs for EC2

EC2 인스턴스에서 CloudWatch로는
기본적으로 어떤 로그도 옮겨지지 않습니다

그러려면 EC2 인스턴스에 에이전트라는
작은 프로그램을 실행시켜 원하는 로그 파일을
푸시해야 합니다

CloudWatch Logs 에이전트가
EC2 인스턴스에서 작동해
CloudWatch Logs로
로그를 보내는 겁니다 그러려면 EC2 인스턴스에
로그를 보낼 수 있게 해주는 IAM 역할이 있어야 합니다
또한 이 에이전트는 온프레미스 환경에서도 셋업될 수 있습니다

여기서의 핵심은 통합 CloudWatch 에이전트가
*더 세부적이고 많은 지표를 수집한다는 겁니다*
기본 EC2 인스턴스 모니터링 보다요

# CloudWatch Alarms

기간은 알람이 얼마나 오랫동안 메트릭을 평가할지를 나타내죠

그리고 알람에는 주요 타깃이 세 가지 있는데요
첫 번째는 정지, 종료, 재부팅 또는 복구 등 EC2 인스턴스에 대한
액션이예요

두 번째는 오토 스케일링 액션을 트리거하는 건데요
예를 들면 스케일 아웃이나 스케일 인이 있죠

그리고 마지막은 SNS 서비스에 알림을 전송하는 건데요, 예를 들어 SNS 서비스를
람다 함수에 연결해서 어떤 알람인지에 따라서 사실상 우리가 원하는 건 뭐든지
할 수 있어요

복합 알람은 ‘알람 노이즈’를 줄이는 데 아주 유용해요, 복잡한 복합 알람을 만들 수 있기 때문이예요

이제 EC2 인스턴스 복구에 대해 얘기해보죠
앞에서 이미 본 적이 있지만, 상태 검사가 있고 EC2 VM 검사가 있어요, 그리고 기본 하드웨어를
검사하는 시스템 상태 검사도 있고요, 그리고 여러분은 그 두 가지 검사에 CloudWatch Alarms을 정의할 수 있어요

그리고 만일 알람 알림을 테스트하고 싶으면 여러분은 set-alarm-state라는 CLI 호출을 사용할 수 있어요
이건 비록 특정한 한도 값에 도달하지 않았지만 알람을 트리거하고 싶을 때 유용해요

# EventBridge

클라우드에서 cron 작업을 예약합니다. 스크립트를 예약 가능합니다. 

이벤트 규칙으로는 이벤트가 발생하면 sns 주제로 메시지를 보내고 이메일 알림을 받을 수 있습니다. 

EventBridge와 CloudTrail을 결합하는 건
좋은 조합이에요

이벤트의 세부 사항을 나타내는 json 문서를 생성합니다. 

파트너 이벤트 버스라는 서비스가 있습니다. 여러분의 계정을 통해 aws 외부에서 일어나는 변화에 반응할 수 있게 되는 겁니다. 

이벤트를 아카이빙할 때는 보존 기간을 무기한이나 일정 기간으로 설정 가능합니다. 이를 통해 아카이브된 이벤트를 재생할 수 있습니다. 

또한 디버깅에 아주 유용합니다. 

스키마를 추론하는 능력이 있습니다. 

EventBridge의 리소스 기반 정책을 살펴보면 이벤트 버스의 권한을 관리합니다. 여러 계정의 모음인 AWS Organizations의
중앙에 이벤트 버스를 두고 모든 이벤트를 모으는 겁니다

# CloudWatch Container Insights

컨테이너로부터 지표와 로그를 수집,집게, 요약하는 서비스입니다. 

ecs, eks, kubernets of ec2 플랫폼에 직접 실행하는 컨테이너, ecs 와 eks 의 fargate에 배포된 컨테이너에서도 사용 가능합니다. 

세분화된 대시보드를 만들 수 있습니다. 

*CloudWatch Container Insights를
Amazon EKS나 Kubernetes
EC2에서 실행되는 Kubernetes에서 사용할 경우
컨테이너화된 버전의 CloudWatch 에이전트를 사용해야*

다음 유형은 Lambda Insights입니다. Lambda 에서 실행되는 서버리스 애플리케이션을 위한 모니터링과 트러블 슈팅 솔류션입니다. 

다음은 Contributor Insights입니다. 기고자(Contributor) 데이터를 표시하는 시계열 데이터를 생성하고 로그를 분석하는 서비스입니다. 불량 호스트를 식별해 낼 수 있습니다. 

상위 10개의 기고자 또는 비슷한 걸 본다면
Contributor Insights를 떠올리세요

--

마지막은 CloudWatch Application Insights예요
모니터링하는 애플리케이션의 잠재적인 문제와
진행 중인 문제를 분리할 수 있도록
자동화된 대시보드를 제공합니다

발견된 문제와 알림은 모두
Amazon EventBridge와 SSM OpsCenter로 전달됩니다

# CloudTrail

aws 계정의 거버넌스, 컴플라이언스, 감사를 실현하는 방법입니다. 

기본값으로 활성화 되어있습니다. aws 계정안에서 일어난 모든 이벤트와 api 호출 이력을 콘솔, sdk, cli 또는 기타 aws 서비스를 통해 얻을 수 있습니다. 

그리고 그런 로그들을 CloudTrail에서 CloudWatch Logs나 Amazon S3에 넣을 수도 있어요

그리고 모든 이벤트를 90일 이상 보관하고 싶으면 그걸 CloudWatch Logs나
S3 버킷에 전송할 수 있어요

CloudTrail 에서 볼 수 있는 이벤트는 세가지입니다. 

첫째는 관리 이벤트입니다. aws 께정 안에서 리소스에 대해 수행된 작업을 나타냅니다. 읽기 및 쓰기 이벤트가 있습니다.

다음으로는 데이터 이벤트가 있습니다. 별도 고요 기본값으로서 데이터 이벤트는 로깅되지 않아요 고용량 작업입니다. 이벤트에는 s3 객체 수준의 활동이 있습니다. 

다음은 CloudTrail Insights 이벤트가 있습니다. 
여러분의 계정에서 일어나는 이벤트를 분석하고 비정상적인 활동에 대한 탐지를 시도해요

마지막으로 CloudTrail 이벤트 보관에 대해 얘기해보죠

기본값으로서 이벤트는 CloudTrail에 90일 동안 보관되고요, 그 기간이 지나면 삭제되요
그리고 그것들을 분석할 준비가 되면 여러분은 S3의 데이터를 쿼리하는 서버리스 서비스인 Athena 서비스를 사용해서
여러분이 원하는 이벤트를 검색하고 더 자세히 알아보죠

# Amazon EventBridge - intercept Api calls

EventBridge와의 통합은 여러분이 꼭 알아두셔야 할 중요한
CloudTrail 통합이에요

그럼 아시는 것처럼 AWS에서는 API 호출을 할 때마다 API 호출 자체가 CloudTrail에 로깅될 거예요 모든 API 호출이 로깅되죠

![image](https://github.com/InHeeS/Certified-AWS/assets/105423951/65f85dcd-a8ed-4070-987a-e93c38b1fa59)

# aws config

aws 내 리소스에 대한 감사와 규정 준수 여부를 기록할 수 있게 해주는 서비스 입니다. 

설정에 규칙된 기반해 구성과 구성의 시간에 따른 변화를 기록할 수 있으며 인프라를 빠르게 롤백하고 문제점을 찾아냅니다. 

리전별 서비스이기 때문에 모든 리전별로 구성해야 하며 중앙화하기 위해 리전과 계정 간 데이터를 통합할 수 있습니다. 

config 내에서 행동을 차단할 숭수는 없지만 ssm 자동화 문서를 이요해서 규정을 준수하지 않는 리소스를 수정할 수 있습니다. 

예를 들어 보안 그룹을 모니터링하다가 규정 미준수 상태가 됐다면
EventBridge에서 이벤트를 트리거 해서
원하는 리소스에 넘길 수 있는 거죠

또는 모든 구성 변경과 모든 리소스의
규정 준수 여부 알림을 Config에서
SNS로 보낼 수도 있습니다

한 구성 항목이 있고
특정 이벤트에만 적용되게 필터링 하고 싶다면
SNS 필터링을 사용해 SNS 주제를 필터링할 수 있습니다

그리고 알림을 전송할 수 있죠 예를 들어
관리자 이메일이나 Slack 채널 등으로요
모든 알림을 한 곳에 집중시키는 거죠

# CloudWatch vs CloudTrail vs Config

CloudWatch는 지표, CPU 네트워크 등의 성능 모니터링과
대시보드를 만드는 데 사용됩니다
또 이벤트와 알림을 받을 수도 있고
로그 집계 및 분석 도구도 사용할 수 있습니다

CloudTrail은 생소할 수도 있지만 기본적으로
계정 내에서 만든 API에 대한 모든 호출을 기록합니다
누구에 의한 호출이든 간에 말이죠
그리고 특정 리소에 대한 추적도 정의할 수 있습니다
그러면 EC2에 대한 정보만 더 얻을 수도 있겠죠
또한 글로벌 서비스입니다

Config는 구성 변경을 기록하고
규정 준수 규칙에 따라 리소스를 평가합니다
변경과 규정 준수에 대한 타임라인을
멋진 UI로 보여줍니다
세 가지 모두 전혀 다른 서비스입니다

# quiz

Question 2:
최소 용량을 2로 구성한 오토 스케일링 그룹이 관리하고 있고, 한 세트의 EC2 인스턴스에서 호스팅하고 있는 애플리케이션이 있습니다. 또한 CPU 사용률이 60%에 이르면 ASG를 스케일 인하도록 구성된 CloudWatch 경보도 생성해 둔 상태입니다. 현재, 이 애플리케이션은 2개의 EC2 인스턴스 상에 실행되고 있으며, 트래픽의 수준은 낮고, CloudWatch 경보는 ALARM 상태에 있습니다. 이런 경우, 무슨 일이 일어나게 될까요?

Answer : CloudWatch 경보는 계속 alram 상태로 유지되지만, asg의 ec2 인스턴스 수는 절대 감소하지 않음 

Question 8:
84번 포트가 취약한 것으로 알려진 OS를 지닌 EC2 인스턴스 플릿에서 웹사이트를 실행하고 있습니다. 84번 포트가 노출된 경우에는 EC2 인스턴스를 지속적으로 모니터링하려 합니다. 이 경우, 어떻게 해야 할까요?

Answer : 구성 규칙 설정 

Question 15:
회사는 Lambda, DynamoDB, Cognito를 사용해 AWS에서 서버리스 애플리케이션을 개발하고 있습니다. 몇 주 전에 합류한 주니어 개발자가 실수로 개발용 AWS 계정에서 중요한 데이터가 포함된 DynamoDB 테이블 중 하나를 삭제했습니다. CTO는 같은 일이 다시 발생하지 않도록 요청했고, 이를 위해서는 DynamoDB 테이블에 대해 삭제 작업을 수행하려는 시도가 있는지 모니터링해 알려주는 시스템이 있어야 합니다. 어떻게 하시겠습니까?

Answer : 테이블 삭제 권한이 없는 iam 그룹에 할당하고, EventBridge 가 cloudTrail 로 모돈 DeleteTable api 호출을 캡처허 sns 로 알림을 보내도록 설정한다. 

