# RDS

rds 는 관계형 데이터베이스 서비스의 약자로 sql을 쿼리 언어로 사용하는 데이터베이스용 관리형 db 서비스입니다. 
db 엔진 유형에는 postgreSQL, mysql, mariadb, oracle microsoft sql server aurora 가 있습니다. 
ec2 인스턴스에 자체 db 서비스를 배포하지 않고 rds 사용하는 이유가 있습니다. 

데이터 베이스 프로비저닝과 기본 운영체제 패치가 완전 자동화 되어있습니다. 
재해 복구 목적으로 다중 az를 설정 가능합니다. 때문에 수평 확장이 가능합니다. 

파일 스토리지는 ebs에 구성됩니다. rds 인스턴스에 ssh 액세스는 불가능 하며 기본 ec2 인스턴스에 액세스할 수 없습니다. 
rds 스토리지 오토 스케일링 기능을 활성화 하면 db를 다운시키는 등의 작업은 필요 없습니다. 

*rds 읽기 전용 복제본과 다중 az 차이의 이해가 필요합니다. 즉 사용사례를 제대로 알아야 합니다*
읽기 전용 복제본은 읽기를 스케일링합니다. 두개의 rds 인스턴스 읽기 전용 복제본이 있다며 주된 rds 데이터베이스 인스턴스와 두 읽기 전용 복제본 사이에 비동기식 복제가 발생합니다. 
복제본 중 하나를 데이터베이스로 사용하고자 하며 그에 대한 권한을 획득하면 이를 데이터베이스로 승격 가능합니다. 하지만 자체적인 생애 주기를 갖습니다. 
읽기 전용 복제본이 있는 경우에는 select 명령문만 사용합니다. aws 에서는 하나의 가용 영역에서 다른 가용 영역으로 데이터가 이동할 때에 비용이 발생합니다. 
예외는 보통 관리형 서비스에서 나타납니다. rds 는 동일한 리전 내에서는 비용이 발생하지 않습니다. 

다중 az 는 주로 재해 복구에 사용됩니다. 마스터 데이터베이스 인스턴스는 다른 가용영역에 스탠바이 인스턴스로 복제합니다. 마스터 db의 모든 변화를 동기적을 복제합니다. 
즉 하나의 dns 이름을 갖고 장애 발생시에 스탠다드 db에 자동으로 장애 조치가 수행됩니다. 
또한 읽기 전용 복제본을 자둥 az로 설정 가능합니다. 
*시험에서는 단일 az에서 다중 az로 rds db 전환이 가능한지 물어봅니다.*
이 작업에는 다운 타임이 전혀 없는 점을 염두에 둬야 합니다. 즉 데이터베이스를 중지할 필요가 없습니다. 이를 통해 rds db 인스턴스는 마스터를 갖고 동기식 복제본인 스탠바이 db를 확보합니다. 
기본 데이터베이스의 rds 가 자동으로 스냅샷을 생성합니다. 이 스냅샷은 스탠바이 db에 복원 됩니다. 복원이 된다는 시점은 동기화가 설정되므로 메인 rds db를 수용하여 다중 az가 됩니다. 

rds에서는 기저 운영 체제나 사용 자 지정 기능을 액세스합니다. 
rds custom 은 두 유형의 db를 다룹니다. -> oracle, microsoft sql server
rds custom 덕분에 os 및 db 사용자 지정 기능에 액세스합니다. 
즉 내부 설정 구성, 패치 적용 그리고 네이티브 기능 확성화가 가능합니다. 
ssh 또는 ssm 세션 관리자를 사용해서 rds 뒤에 있는 기저 ec2 인스턴스에 액세스 가능합니다. 
즉 자동화를 꺼두어서 문제를 예방하거나 스냅샷을 만들어 놓는 것이 조으며 기저 운영 체제 와 데이터베이스에 대한 관리자 권한 전체를 갖게 되는 것입니다. 

# Amazon Aurora 

*시험에 많이 나오지만 어떻게 작동하는지 전반적인 이해만 필요하다*
오픈 소스는 아니며 postgre & mysql 과 호환됩니다. 
클리우드에 최적화 되어 있으며 mysql 보다 5배 postgre 보다 3배 성능이 좋습니다. 
db나 sysops 처럼 저장 디스크를 신경 쓰지 않습니다. 읽기 전용 복제본의 경우 15개의 복제본을 둘 수 있습니다.  도한 장애 조치는 즉각적입니다. 
기본적으로 클라우드 네이티브이므로 가용성이 높습니다. 즉 스케일링 측면에서 훨씬 더 효율적입니다. 
오히려 비용을 절감할 수 있으며 중요한 부분은 높은 가용성과 읽기 스케일링입니다. 

필요 이상의 az 에 걸처 사본을 저장하며 일부 데이터가 손상되거나 문제가 있으면 백엔드에서 p2p 복제를 통한 자가 복구가 가능합니다. 즉 스트라이프 형식으로 사본이 생성됩니다. 

aurora 는 rds 의 다중 az와 유사하며 쓰기를 받는 인스턴스는 하나 뿐입니다.
마스터가 문제가 생기면 읽기 전용 본제본중 하나가 마스터가 됩니다. 복제본들은 리전간 복제를 지원합니다. 즉, 작은 블록 단위로 자가 복구 도는 확장이 일어납니다. 

스토리지에 쓰는것은 마스터만 가능하며 aurora 에서는 writer 엔드 포인트를 제공합니다. 이 엔드포인트는 dns 이름으로 항상 마스터를 가리킵니다. 즉 장애 조치 후에도 클라이언트는 라이터 엔드포인트와 상호작용하게 되며 올바른 인스턴스로 리다이렉트 됩니다. 

*리더 엔드포인트는 라이터 엔드포인트와 정확히 같은 기능을 합니다. 연결 로드 밸런싱에 도움을 줍니다. 도한 모든 읽기 전용 복제본중 하나로 연결되며 이런 방식으로 로드 밸런싱을 도와줍니다. 즉 로드 밸런싱이 문장 레벨이 아닌 연결 레벨에서 일어나게 됩니다.* 

*라이터 엔드포인트와 리더 엔트포인트를 기억하시길 바랍니다
자동 스케일링, 자동 확장되는 공유 스토리지 볼륨도 기억하시고요
이 도식을 보고 이해하시면 Aurora 작동 방식도 이해하실 거예요
기능을 더 자세히 살펴보면 제가 이미 말씀드린 내용이 나옵니다
자동 장애 조치, 백업 및 복구
격리 및 보안, 산업 규정 준수
자동 스케일링을 통한 버튼식 스케일링 제로 다운타임 자동 패치 설치 등
이 모든 일이 실제로 백엔드에서 일어납니다* 

![image](https://github.com/InHeeS/Certified-AWS/assets/105423951/a366be3a-25d7-454d-8b39-a7f9102a2a27)

# Aurora Advanced 

복제본 auto scaling 은 한개는 라이터 두개는 리더 엔드포인트로 읽고 있습니다. 리더 엔드포인트는 새로운 레플리카들을 위해 확장될 것입니다. 전체적인 cpu 사용량을 낮출 수 있겠습니다. 읽기 복제본은 다른 것보다 큰 상태인데 aurora 인스턴스의 부분집합을 사용자 지정 엔드포인트로 정의하기 위해서 입니다. 이는 aurora 레플리카의 부분집합에 쿼리하도록 해줍니다. 

서버리스 입니다. 자동화된 데이터베이스 에시화와 실제 사용량에 따른 auto scaling 을 제공합니다. 용량 플랜을 할 필요가 없게 됩니다. 초당 비용 지불하는것이 비용 효율적일 것입니다. 

클로벌 aurora 입니다. aurora 교차 리전 읽기 전용 복제본은 재해 복구에 도움이 많이되고 실행하기 간단합니다. 보조 리전당 16개의 읽기 전용 복제본을 사용할 수있습니다. 재해 복구를위해 다른 리전으로 진급시키는데 1분 이내입니다. aurora 글로벌 데이터베이스에서 한 리전에서 다른 리전으로 데이터를 복제하는데 1초 이하의 시간이 걸립니다. 

aurora 는 기계 학습 서비스 간의 간단하고 최적회돈, 안전한 통합니다. sageMaker로 백엔드인 어떤 종류의 기계학습 모델이라도 사용 가능합니다.
comprehend 는 감정 북성을 할때 사용 됩니다. 기계 학습 서비스는 경험이 필요 없이 스스로 분석을 통해 요청을 보낼것입니다. 

# RDS Backups

자동화된 백업입니다. rds 서비스가 자동으로 매일 데이터 베이스의 전체 백업을 수행합니다. 5분마다 트랜잭션 로그가 백업이 됩니다.
자동 백업 보존 기간은 1 ~ 35 일입니다. 

두번째는 수동 데이터베이스 스냅샷 입니다. 사용자가 수동으로 트리거 합니다.
수동으로 한 백업을 원하는 기간 동안 유지 가능합니다. 

세번째로 데이터 백업은 비용을 절감하고 싶을 때도 사용합니다. 스냅샷은 rds db의 실제 스토리지 비용보다 훨씬 저렴합니다. db를 다시 사용할 준비가 되면 스냅샷을 복원하여 사용합니다. 
aurora 백업도 유사하지만 비활성화 할 수 없습니다. 
다른 옵션은 s3에서 mysql 데이터베이스를 복원 가능합니다. 
rds 는 s3 에서 백업 파일을 복원하는 옵션이 있습니다. 

차이점은, RDS MySQL로 복원할 때는 데이터베이스의 백업만 있으면 되었죠
Aurora MySQL에서는Percona XtraBackup으로 백업을 한 다음, S3에서 Aurora DB 클러스터로 백업을 하면 됩니다

마지막으로 aurora 데이터베이스 복제입니다. 기존 db cluster 에서 새로운 aurora db cluster 생성가능합니다. 스냅샷을 찍고 복원하는 것보다 빠릅니다. 

# RDS & Aurora Security

kms 를 사용해 마스터와 모든 복제본의 암호화가 이루어지며 db를 처음 실행할 때 정의됩니다. 

다음은 클리어인트와 데이터베이스 간의 전송 중 데이터 암호화가 있습니다. 전송중 암호화 기능을 모두 갖추고 있고 aws 의 tls 루트 인증서를 사용합니다. 또한 iam , 보안그룹을 통해 데이터베이스에 대한 네트워크 액세스를 통제 가능합니다. 

그리고 모두 ssh 액세스가 없습니다. 관리형 서비스가 있기 때무입니다. 다만 aws rds custom service를 이용하면 예외입니다. 시간에 따라 RDS 및 Aurora에서 어떤 쿼리가 생성되고 있고데이터베이스를 확인하려면감사 로그 작성을 활성화하면 됩니다
로그는 시간이 지나면 자동으로 삭제되며장기간 보관하고 싶다면AWS에 있는 CloudWatch Logs라는전용 서비스로 전송해야 합니다

# RDS Proxy

vpc 내에 rds 데이터베이스를 배포 가능합니다. 프록시를 연결하면 하나의 풀에 연결을 모아 rds 데이터 베이스 인스턴스로 가는 연결이 줄어듭니다. 
cpu와 ram에 데이터베이스 리소스의 부담을 줄여 데이터베이스 효율성을 향상 시키며 연결과 시간초과를 최소화 합니다. 
*rds 프록시는 완전한 서버리스로 오토 스케일링이 가능해 용량을 관리할 필요가 없고 가용성이 높습니다. 다중 az도 지원합니다.*
장애 조치를 각자 처리하게 하는 대신 장애 조치와 무관한 rds 프록시에 연결합니다. 때문에 장애 조치 시간이 개선됩니다.

*RDS 프록시는 MySQL, PostgreSQL MariaDB용 RDS를 지원하며MySQL, PostgreSQL용 Aurora를 지원합니다.애플리케이션의 코드를 변경하지 않아도 되고RDS 데이터베이스 인스턴스나 Aurora 데이터베이스에 연결하는 대신RDS 프록시에 연결하기만 하면 됩니다*

데이터베이스에 iam 인증을 강제함으로써 iam 인증을 통해서만 rds db 인스턴스에 연결 가능합니다. 자격 증명은 aws secrests manager 서비스에 안전하게 저장됩니다. rds 는 퍼플릭 액세스가 절대로 불가능합니다. vpc 내에서만 액세스 가능합니다. 
같이 사용하면 좋은 서비스로 lambda 함수입니다. lambda 함수는 증식하며 생성과 삭제가 매우 빠르며 rds 프록시를 오버로드합니다. rds 프록시가 풀을 생성하면 rds 데이터베이스 인스턴스 연결이 줄어 문제가 해결 됩니다. 





