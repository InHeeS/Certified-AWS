# Encryption 

tsl 은 ssl 의 가장 최근 버전입니다. 데이터가 전송되기 전에 암호화되고 받은 후에 해독 되는 것입니다. 

데이터를 암호화하기 위해 tls 인증서가 사용 됩니다. 

목표하는 대상 서버만이 저희가 전송하는 암호화된 데이터를 해독합니다. 

즉 보안이 유지된 상태로 로그인 할 수 있는 것입니다. 

서버 측 암호화는
모든 암호화와 해독이 서버에서 일어나는 것입니다

클라이언트 측 암호화는 암호화된 객체는 어느 스토리지 서비스에든 안전하게 전송 됩니다. 

# aws kms(key management Service)

kms 서비스는 우리를 대신해서 암호화키를 관리한다는 개념입니다. 

ebs 볼륨에 저장되어 있는 데이터를 암호화하고 싶으면 kms 통합을 활성화 합니다. s2,rds, ssm 도 마찬가지 입니다. 

비밀 데이터가 있다면 절대로 평문 텍스트에 저장하면 안됩니다. 즉 그대로 두면 안됩니다. 

두가지 유형이 있ㅅ브니다. 

1. 대칭 kms 키가 있습니다.
   데이터를 암호화하고 복호화하는데 사용되는 암호화 키가 하나만 있다는 의미입니다.

   단지 aws api 호출을 이용해서 그 키를 사용할 뿐입니다.

2. 비대칭 kms 키가 있습니다.
   암호화하는데 사용되는 퍼블릭키, 데이터를 복호화하는 데 사용되는 프라이빗 키

kms 키 안에는 다양한 타입의 kms 키가 있습니다. 

첫번재는 aws가 소유한 키입니다. sse-s3 타입의 암호화를 사용하거나 sse dynamoDB를 사용할 대 사용하는 키입니다. 

다음으로는 aws 관리형 키가 있습니다. aws/가 있고 서비스 이름이 나옵니다. 

마지막으로는 고객 관리형 키가 있습니다. api 호출 건에 대해 지불합니다. 

kms 키의 범위는 리전입니다. 동일한 kms 키가 두 리전에 있을 수 없습니다. 

kms 를 이용해서 그 스냅샷을 원래의 ebs 볼륨으로 복구합니다. 

kms 정책으로는 두가지 유형이 있습니다. 

기본 정책은 여러분이 특정한 커스텀 kms 키 정책을 제공하지 않았을때 생성됩니다. kms 키에 대한 교차 계정 액세스를 하렬 경우 유용합니다. 즉 다른 계정이 우리의 kms 키를 사용하도록 승인할 수 있도록 말입니다. 

*시나리오*

예, 예를 들어 암호화된 스냅샷을 계정들 간에 복사하고 싶을 때 사용해요, 그럼 우린 우리의 고객 관리형 KMS 키로
암호화된 스냅샷을 생성하고요

우린 커스텀 키 정책을 첨부해야 되기 때문에 반드시 고객 관리형 KMS 키가 되어야 하죠, 그리고 우린
교차 계정 액세스를 승인하기 위한 KMS 키 정책을 첨부해요
이런 모습이예요

그리고 우린 암호화된 스냅샷을 타깃 계정과 공유하죠
그리고 타깃 계정 안에서 우린 스냅샷의 사본을 생성하고요, 다른 고객 관리형 키를 사용해서 그 타깃 계정 안에서
그걸 암호화하죠

# kms 다중 리전 키

aws kms 에는 다중 리전 키를 둘 수 있습니다. 
즉, 선택된 한리전에 기본 키를 갖는다는 의미입니다. 키 구성 요소가 복제되기 때문입니다. 

다중 리전 키의 핵심은
한 리전에서 암호화하고 다른 리전에서 복호화해
다음 리전으로 복제할 때나 교차 리전 API 호출을 실행할 때
데이터를 재암호화하지 않아도 된다는 점입니다

하지만 KMS 다중 리전 키는 전역으로 사용할 수 없다는 점을 기억하세요

다중 리전 키의 사용 사례에는
전역 클라이언트 측 암호화가 있습니다
한 리전에서 클라이언트 측 암호화를 하고
다른 리전에서 클라이언트 측 복호화를 하는 거죠

데이터베이스 관리자로부터도 보호할 수 있는 것이죠

DynamoDB 테이블이 전역 테이블인 경우
해당 테이블의 데이터는 다른 리전으로 복제됩니다
ap-southeast-2로 복제되죠

다행히 다중 리전 키로 데이터 속성을 암호화하기로 했기 때문에
ap-southeast-2 리전의 클라이언트 애플리케이션은
열을 검색해서 해당 속성이 암호화됐는지 확인한 후
API 호출을 실행해
복제된 다중 리전 키를 사용해 해당 속성을 복호화합니다
다중 리전 키를 사용하는 이유입니다

Amazon Aurora DB에 액세스할 수 있는 DB 관리자가
'사회 보장 번호' 열에 액세스하고자 할 때
KMS 키에 대한 액세스 권한이 없으면
해당 데이터를 읽을 수 없습니다
아주 유용하죠

# s3 replication encryption considerations 

한 버킷에서 다른 버킷으로 S3 복제를 활성화하면

암호화되지 않은 객체와 SSE-S3로 암호화된 객체가 기본으로 복제됩니다

SSE-KMS로 암호화된 객체도 있습니다
기본적으로 복제되지 않지만
만약 객체를 복제하려면
옵션을 활성화해야 합니다

따라서 어떤 KMS 키로
대상 버킷 내 객체를 암호화하는지 지정해야 합니다
그리고 이 KMS 키 정책을 대상 키에 적용해야 하고
S3 복제 서비스를 허용하는 IAM 역할을 생성해서
소스 버킷의 데이터를 먼저 복호화하도록 한 뒤
대상 KMS 키로 대상 버킷의 데이터를 다시 암호화합니다
이렇게 하면 복제가 활성화되는데
이는 수많은 암호화와 복호화가 발생하기 때문입니다

KMS 스로틀링 오류가 발생한 경우는 서비스 할당량을 요청해야 합니다


# exam

ami 를 다른 계정과 공유하는 과정에 관한 것으로 aim는 kms 키로 암호화 되어 있습니다. 

어떤 방식으로 A 계정의 AMI에서 B 계정의 EC2 인스턴스를 시작할까요?

먼저, 시작 권한으로 AMI 속성을 수정해야 하는데
이 시작 권한은 B 계정에서 AMI를 시작하도록 허용합니다

이렇게 AMI를 공유합니다
시작 권한을 수정하고 특정 대상인 AWS 계정 ID를 추가하는 것이죠

그런 다음 B 계정에서 사용하도록 KMS 키도 공유해야 하므로
일반적으로 키 정책으로 실행됩니다

이제 B 계정에서 KMS 키와 AMI를 모두 사용할 수 있는
충분한 권한을 가진 IAM 역할이나 IAM 사용자를 생성합니다

따라서 DescribeKey API 호출과 ReEncrypted API 호출
CreateGrant, Decrypt API 호출에 관한 KMS 측 액세스 권한이 있어야 합니다

모두 완료된 후에는 AMI에서 EC2 인스턴스를 시작하면 되는데
선택 사항으로 대상 계정에서 자체 계정의 볼륨을 재암호화하는
KMS 키를 이용해 전체를 재암호화할 수 있습니다

# Ssm parameter Store

구성 및 암호를 위한 보안 스토리지 입니다. 

구성을 암호화할시 선택 하므로 kms 서비스를 이용해 암호를 만듭니다. 

서버리스이며 확장성과 내구성이 있고 sdk 도 사용이 용이합니다. 

구성과 암호의 버전을 추적할 수도 있습니다
특정한 경우에는 Amazon EventBridge로 알림을 받을 수도 있어요
CloudFormation과 통합도 됩니다

이렇게 여러분이 원하는 방식으로 매개변수를 구조화할 수 있습니다

Systems Manager에는 두 가지 매개변수 티어가 있는데
바로 표준과 고급입니다
가장 큰 차이는 용량으로 각각 4KB, 8KB입니다

![image](https://github.com/InHeeS/Certified-AWS/assets/105423951/9d76decf-d843-45fd-aebe-1eaa43d19e98)

# aws secrets Manager

ssm parameter store과는 다른 서비스 입니다. 

Secrets Manager는 X일마다 강제로 암호를 교체하는 기능이 있어
암호 관리를 더 효율적으로 할 수 있죠

또한 AWS Secrets Manager로
교체할 암호를 강제 생성 및 자동화할 수 있습니다

AWS가 제공하는 다양한 서비스와도 아주 잘 통합됩니다
Amazon RDS, MySQL PostgreSQL, Aurora 등이 있죠
AWS 외 여러 서비스와 데이터베이스에도 즉시 통합할 수 있어요

*암호는 KMS 서비스를 통해 암호화됩니다
RDS와 Aurora의 통합 혹은 암호에 대한 내용이 시험에 나오면
AWS Secrets Manager를 떠올리세요*

이는 복수 AWS 리전에 암호를 복제할 수 있고
AWS Secrets Manager 서비스가
기본 암호와 동기화된 읽기 전용 복제본을 유지한다는 개념인데요
이렇게 두 리전이 있을 때 기본 리전에 암호를 하나 만들면
보조 리전에 동일한 암호가 복제됩니다

이유로는 다중 리전 앱을 구축하고 재해 복구 전략도 짤 수 있습니다. 

# ACM

tls 인증서를 aws 에서 프로비저닝, 관리 및 배포하게 해해줍니다. 

웹사이트엣 전송 중 암호화를 제공합니다. 

퍼블릭과 프라이빗 tls 인증서를 모두 지원하며 자동 갱신 기능이 있습니다. 
Elastic Load Balancer(ELB)에 TLS 인증서를 불러올 수 있습니다


다만 ACM을 사용할 수 없는 곳이 하나 있는데
그건 바로 EC2 인스턴스입니다
퍼블릭 인증서일 경우 추출이 불가능하거든요
ACM을 통해 EC2 인스턴스에 대한 퍼블릭 인증서를 생성할 수 없단 거죠

자동화를 목적으로 SSL 인증서를 자동 갱신하려면
DNS 검증을 쓰는 편이 낫겠죠

DNS 구성에서 CNAME 레코드를 생성해
도메인 소유권을 증명해야 합니다

Route 53이 있다면 ACM과 자동으로 통합해            
이러한 작업을 수행해주죠


그럼 ACM에서 퍼블릭 인증서는 어떻게 가져오면 될까요?
ACM 외부에서 생성된 인증서를 ACM으로 가져오는 옵션도 제공하는데요
ACM 외부에서 생성되었기 때문에 자동 갱신은 불가능합니다
그러니 인증서가 만료되기 전에 직접 새 인증서를 가져와야 하죠

인증서가 언제 만료되는지는 어떻게 알 수 있냐고요?
ACM 서비스가 만료 45일 전부터 매일 만료 이벤트를
EventBridge 서비스에 전송해 줍니다

Config 서비스가 ACM 서비스를 검사해서
규칙에 위배되는 인증서가 있을 경우
규정 비준수 이벤트가 EventBridge로 전송됩니다

먼저 엣지 최적화(edge-optimized) 유형이 있는데요
이 유형은 글로벌 클라이언트를 위한 유형으로
먼저 CloudFront 엣지 로케이션으로 요청을 라우팅하여
지연을 줄이는 방법으로
하나의 리전에만 있는 API Gateway로 보내지는 경우입니다

리전(regional) 엔드 포인트 유형은
클라이언트가 API Gateway와 같은 리전에 있을 때를 쓰이죠
이 경우 CloudFront는 사용할 수 없지만
자체 CloudFront 배포를 생성하여
캐싱 및 배포 전략을 제어할 수는 있습니다

ACM을 API Gateway와 통합하려면 우선 API Gateway에
사용자 지정 도메인 이름이라는 리소스를 생성하고
구성해야 합니다

TLS 인증서를 API Gateway에 가져올 때는
같은 리전에 속해 있어야 합니다

그리고 Route 53에서 CNAME이나 별칭 레코드가
여러분의 DNS를 가리키도록 설정하면 됩니다

![image](https://github.com/InHeeS/Certified-AWS/assets/105423951/ef6daff1-96d9-4827-a778-6123c8401cb8)

# WAF

AWS WAF는 계층 7에서 일어나는 일반적인 웹 취약점 공격으로부터
웹 애플리케이션을 보호합니다

*웹 애플리케이션 방화벽(WAF)의 배포는
애플리케이션 로드 밸런서, API Gateway CloudFront
AppSync GraphQL API Cognito 사용자 풀에 할 수 있습니다*

URI 문자열을 조건으로 두어
SQL 주입, 크로스 사이트 스크립팅(XSS) 등의 일반적인 공격을 차단할 수도 있습니다

또 속도 기반 규칙을 설정하면 IP당 요청 수를 측정하여
디도스 공격을 막을 수도 있죠

이러한 웹 ACL은 리전에만 적용되며
CloudFront는 글로벌로 정의됩니다

*WAF는 네트워크 로드 밸런서(NLB)를 지원하지 않죠
NLB는 L4에서 WAF는 L7에서만 작동하니까요
따라서 WAF를 제공하려면 애플리케이션 로드 밸런서가 있어야 합니다*

하지만 아시다시피 애플리케이션 로드 밸런서는 고정 IP가 없죠
이런 문제는 AWS Global Accelerator로
고정 IP를 할당받은 다음
ALB에서 WAF를 활성화하면 해결할 수 있습니다

![image](https://github.com/InHeeS/Certified-AWS/assets/105423951/2e4e0db7-21c5-420d-b67d-98af313a52b9)

# shield

디도스 공격으로부터 스스로를 보호하기 위한 서비스 입니다. 

디도스 분산 서비스 거부 공격이라는 뜻으로 

shield 스탠다드 서비스를 이용하면 되는데 이 서비스는 모든 AWS 고객에게 무료로 활성화되어 있는 서비스로
SYN/UDP Floods나 반사 공격 및
L3/L4 공격으로부터 고객을 보호해 줍니다

따라서 디도스 공격으로 인한 요금 상승을
AWS Shield 어드밴스드를 통해 방지할 수 있겠죠
자동으로 WAF 규칙을 생성, 평가, 배포함으로써
L7 공격을 완화할 수 있습니다

# firewall manager

AWS Organizations에 있는 모든 계정의
방화벽 규칙을 관리하는 서비스인데요
여러 계정의 규칙을 동시에 관리할 수 있죠

또한 보안 규칙의 집합인 보안 정책을 설정할 수 있는데
여기에는 ALB, API Gateway CloudFront 등에 적용되는
웹 애플리케이션 방화벽(WAF) 규칙이나
ALB, CLB, NLB, 엘라스틱 IP CloudFront를 위한
AWS Shield 어드밴스드 규칙 등이 포함됩니다

AWS Firewall Manager는 이와 같은 모든 방화벽을
한 곳에서 관리할 수 있도록 지원해 줍니다

*리소스별 보호를 구성하는 데에는 WAF가 적절합니다*

*하지만 여러 계정에서 WAF를 사용하고
WAF 구성을 가속하고 새 리소스 보호를 자동화하려면
Firewall Manager로 WAF 규칙을 관리하면 됩니다*

또한 Firewall Manager는
모든 계정에 Shield 어드밴스드를 배포에도 도움을 주죠

*그리고 Shield 어드밴스드는 디도스 공격으로부터 고객을 보호하고
WAF의 기능 외에도 더 많은 기능을 제공합니다
예를 들어 Shield 대응 팀 지원 고급 보고서 제공
그리고 WAF 규칙 자동 생성 등의 기능을 추가로 이용할 수 있죠*

# 다음 강의 중요!!!

# guardduty

GuardDuty를 사용하면 지능형 위협 탐지를 이용해서 여러분의 AWS 계정을 보호할 수 있어요

예, GuardDuty에는 머신러닝 알고리즘이 있어서 이상 탐지를 수행하고요, 서드파티 데이터를 사용해서
위협을 탐지해요

GuardDuty는 여러분의 CloudTrail Event Logs 같은 많은 입력 데이터를 확인해서
비정상적인 API 호출이나 무단 배포를 검색할 거예요

그럼 예를 들어 관리 이벤트는 VPC 서브넷 생성 이벤트 등을 검색하게 되고요

S3 데이터 이벤트의 경우엔 GetObject, ListObject, DeleteObject 등을 검색할 거예요

그리고 VPC Flow Logs의 경우엔 비정상적인 인터넷 트래픽을 검색할 거고요

예를 들어 여러분의 EKS 감사 로그나 RDS 및 Aurora 로그인 이벤트, EBS, 람다

S3 데이터 이벤트 등 다른 입력 데이터 소스를 검색할 수 있죠

또 우린 EventBridge 규칙을 설정해서, 발견된 결과가 있으면 자동으로 알림을 받을 수도 있어요

*GuardDuty는 암호화폐 공격을 방어하기 위한 아주 좋은 도구예요, 전문적인 탐지 기능이
제공되거든요
즉 그런 모든 입력 데이터를 분석하는 방법을 알고, 암호화폐 공격이 있는지 확인하게 되죠*

![image](https://github.com/InHeeS/Certified-AWS/assets/105423951/c85dbee2-271a-4072-afa6-e85bc1bd0c38)

# amazon inspector

Amazon Inspector는 몇 군데에서 자동화된 보안 평가를 실행할 수 있는
서비스입니다

먼저 EC2 인스턴스에서입니다, EC2 인스턴스에서 시스템 관리자 에이전트를 활용하면
Amazon Inspector가 해당 EC2 인스턴스의 보안을 평가하기 시작할 것입니다

Amazon Inspector가 작업을 완료하면 결과를 AWS 보안 허브에 보고합니다

또한 이러한 결과 및 결과 이벤트를 Amazon Event Bridge로 보냅니다

*Inspector는 실행 중인 EC2 인스턴스, Amazon ECR의 컨테이너 이미지, Lambda 함수에만
사용된다는 점을 기억해야 합니다, 필요할 때 인프라만 지속적으로
스캔합니다*

실행될 때마다, 우선 순위를 정하기 위해 위험 점수가 모든 취약성과 다시 연관됩니다

# Amazon Macie

Macie는 완벽히 관리되는 데이터 보안 및 데이터 프라이버시 서비스고요, 머신러닝과
패턴 매칭을 이용해서 AWS에 있는 여러분의 민감한 데이터를 발견하고 보호해요

더 구체적으로 말하자면 개인식별정보, 즉 PII 같은 민감정보에 관해
경보를 제공해요

그럼 아주 간단히 보면, 여러분의 S3 버킷에 PII가 있다면 그게 Macie에 의해 분석될 거고요
Macie는 어떤 데이터를 PII로 분류할 수 있는지 알아내고, EventBridge를 통해

발견 결과를 알려주죠
그러면 여러분은 그걸 SNS 토픽이나 람다 함수와 통합할 수 있고요

# quiz

Question 9:
S3 버킷과 EBS 스냅샷 모두를 암호화하는 데에 사용한 고객 관리형 CMK를 KMS에서 생성했습니다. 기업 정책에 따라 암호화 키를 매 3개월마다 교체해야 합니다. 어떻게 해야 할까요?

Answer : kms cmk 를 수동으로 교체, kms cmk 를 생성하고 키 별칭을 사용해 새로운 kms cmk 를 참조, 오래된 데이터의 복호화를 위해 기존의 kms cmk 는 유지 

Question 12:
암호화 목적으로 사용하는 암호 값이 있고, 시간 경과에 따라 암호의 값을 저장하고 추적하려 합니다. 이 경우, 다음 중 어떤 AWS 서비스를 선택해야 할까요?

Answer : ssm 파라미터 스토어 

Question 15:
AWS GuardDuty는 다음 중 ................를 제외한 데이터 소스를 스캔합니다.

Answer : cloudwatch 로그

Question 24:
AWS 리전 us-west-2에 메인 엣지 최적화 API Gateway를 생성했습니다. 이 엣지 최적화 API Gateway는 ap-southeast-1에 있는 하위 레벨 API Gateway로 트래픽을 전달합니다. 메인 API Gateway를 보호하기 위해 ACM 인증서를 연결하려고 합니다. 어느 AWS 리전에서 ACM 인증서를 생성해야 합니까?

Answer : us-east-1

Question 25:
AWS Organization으로 여러 AWS 계정을 관리하고 있습니다. 각 계정에는 서로 다른 리소스를 사용하는 별도의 애플리케이션이 있습니다. 지난 주 보안 사고가 발생하여 리소스 관리를 강화하기 위해 계정 전반에 대한 보안 그룹과 WAF 규칙 관리를 쉽게 할 수 있는 방법을 찾고 있습니다. 이런 경우에 도움이 될 만한 AWS 서비스는 무엇입니까?

Answer : Aws firewall Manager


