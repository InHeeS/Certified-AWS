# serverless

serverless 서비스를 사용하는 개발자는 서버를 관리할 필요가 없습니다. 그냥 코드를 배치하면 됩니다. 함수를 배치하는거죠 

AWS에는 Lambda, DynamoDB Cognito, API Gateway, Amazon S3
그리고 앞서 다루었던 SNS와 SQS 등이 있습니다. 또한 Autoroa Serverless, Step funtuins, fargate, kinesis data firehose

# Lambda 

ec2의 효율적으로 시작 중단을 위해 사용됩니다. 

온디맨드로 실행됩니다. 비용 역시 함수가 실행되는 최대 15분동안만 청구됩니다. 요청의 횟수에 다라 과금이 됩니다. 호출 횟수와 컴퓨팅 시간 , 즉 lambda 함수가 실행된 시간만큼 청구됩니다. 

프래그래밍 언어도 다양하게 사용 가능합니다. 

함수당 최대 10gb 의 램을 프로비저닝 합니다. 

함수의 ram을 증가시키면 cpu 및 네트워크 품질과 성능도 함께 향상됩니다. 

컨테이너 이미지를 지원합니다. 이미지 자체가 lambda의 런타임 api를 구현해야 합니다. 즉 전제 조건이 필요합니다. 

*따라서 시험에서 Lambda에 컨테이너를 실행해야 할 경우
해당 컨테이너가 Lambda 런타임 API를 구현하지 않으면
ECS나 Fargate에서 컨테이너를 실행해야 합니다*

Lambda 함수의 통합의 예시

![image](https://github.com/InHeeS/Certified-AWS/assets/105423951/3a9bb0e4-3159-4d55-937c-b594ad36636a)


cron 작업이 있습니다.

cron 이란 ec2 인스턴스에서 작업ㅇ르 생성하는 방법인데 가상 서버에서 실행되며 아무일도 안하면 인스턴스 시간이 낭비됨으로 cloudwatch 이벤트 규칙 도는 eventBridge 규칙을 만들고 태스크를 수행해야 서버리스 cron을 만들 수 있습니다. 

정말 저렴 합니다. 1ms 단위로 요금이 부과되며 
gb-seconds 는 함수가 ?GB ram 을 가질 대 실행 시간이 40만 초이며 다시말해
실행 시간이 배수로 늘어나려면 ram의 크기는 줄어듭니다. 이후에는 60만 gb-s 초당 1달러가 과금됩니다.  

# lambda 한도 

*(중요)*

한도에는 실행 한도와 배포 한도가 있습니다. 

실행시 메모리 할당량은 128mb에서 10gb 이고 메모리는 1mb씩 증가합니다. 환경변수는 4kb까지 가질 수 있습니다.  /tmp 폴더에 용량이 있으며 최대 10gb 입니다. 최대 1000개 까지 동시 실행이 가능하며 동시성은 미리 예약해 두는 것이 좋습니다.

배포 한도를 살벼보면 압축시 최대 크기는 50mb 아닐 때는 250mb 입니다. 이용량이 넘을 파일을 경우 /tmp 공간을 사용해야 합니다. 배포시에도 환경변수의 한도는 4kb 입니다. 

예를 들어서 30gb의 ram과 30분의 실행 시간이 필요하고 3gb의 큰 파일이 있을때는 lambda 함수가 적합하지 않습니다. 

# lambda snap start

함수의 성능을 높이기 위한 기능입니다. snap start 활성화 되어있으면 함수가 미리 초기화된 상태에서 호출됩니다. 이후 메모리와 초기화된 함수의 디스크 상태의 스냅샷이 생성된 후 마지막으로 이 스냅샷이 저지연 액세스를 위해 캐시될 것입니다. 

# customization at the edge

cloudFront 를 사용할 때는 엣지 로케이션을 통해 콘텐츠를 배포합니다. 애플리케이션에 도달하기 전에 엣지에서 로직을 실행하도록 요구하는데 이것을 엣지 함수라하며 cloudfront 배포에 연결하는 코드입니다. 

지연 시간을 최소화 하는 것이 목적입니다. 

cloudfront 함수와 lambda@Edge 의 두가지 cloudfornt 함수가 있습니다. 

엣지 함수를 사용하면 서버를 관리할 필요가 없습니다. 전역으로 배포되기 때문이죠 

사용 사례로는 cloudfront 의 cdn 콘텐츠를 사용자 지정하는 경우를 들 수 있습니다. 웹사이트 보안과 프라이버시 입니다. 

엣지에서의 동적 웹 애플리케이션에도 쓰이고 검색 엔진 최적화 에도 활용 가능합니다. 오리진 및 데이터 센터간 지능형경로, 실시간 이미지 변환 a/b 테스트 사용자 인증 및권한 부여, 사용자 우선순의 지정 사용자 추적 및분석등 다양한 사용자 지정에 활용됩니다. 

cloudfront 함수는 시작 시간은 1밀리초 미만이여 초당 백만개의 요청을 처리합니다. 네이티브 기능으로 모든 코드가 직접 관리됩니다. 고성능, 고확장성이 필요할 때 뷰어 요청과 뷰어 응답에만 사용됩니다.

Lambda@Edge의 기능은 node.js 나 python 으로 작성하며 초당 수청 개의 요청을 처리합니다. cloudfront 요청 및 응답을 변경할 수있습니다. 
CloudFront는 JavaScript만 Lambda@Edge는 Node.js와 Python을 지원합니다
CloudFront 함수의 확장성은 매우 높습니다
수백만 개의 요청을 처리하죠 Lambda@Edge는 수천 개 수준인 반면에요
트리거가 발생 위치도 크게 다릅니다
Lambda@Edge는 뷰어와 오리진 모두에게 영향을 미치는 반면
CloudFront 함수는 뷰어에만 영향력이 있습니다

*CloudFront 함수의 최대 실행 시간은 1밀리초 미만입니다
아주 빠르고 간단한 함수이죠
Lambda@Edge는 실행에 5~10초가 소요됩니다
이 함수들로 여러 로직을 실행할 수 있는데요*

cloudfront 함수는 캐시 키를 정규화 합니다. 헤더를 조작하고 jwt생성하거나 검증하는 요청 인증 및 권한 부여 사용 됩니다. 1밀리초이내에 이뤄집니다.

lambdat@Edge 는 10초가 걸리수도 있고 cpu와 메모리가 증가하므로 타사 라이브러리에 코드의존, 외부 서비스에서 데이터 처리 및 대규모 데이터 통합, 파일 시스템이나 http 요청 본문에도 바로 액세스 가능 즉 사용자 지정이 가능합니다. 

# Lambda in vpc

vpc 내에서 lambda 함수를 시작하면 프라이빗 api 액세스 하는 것이 가능합니다. 

그러기 위해서는 서브넷을 지정하고 lambda함수에 보안 그룹을 추가합니다. 사용 사례로는 rds 프록시입니다. 하지만 부하가 발생할 수 있고 이를 해결하는 방법은 rds 프록시를 시작하는 것입니다. 프록시가 연결을 한곳으로 모으고 rds db 인스턴스 연결의 수를 줄입니다. 

rds 프록시의 장점으로 확장성, 장애조치, 가용성 향상, 연결보존

rds 와 aurora 모두에 적용되며 iam 인증을 통해 보안을 높이며 자격 증명은 secrets manager에 저장됩니다. 

# invoking lambda from rds & aurora

db 인스턴스 안에서 람다 함수를 호출할 수도 있습니다. 
rds for postgresql 과 aurora mysql에 지원됩니다. 

console 이아닌 db에 접속하고 그 안에서 설정해야 하는 것들입니다. 즉 모든 방식으로 오는 트래픽을 허용해야되는데 퍼플릭 람다가 있을 수 있기 때문에죠 즉 rds db인스턴스로부터 람다 함수로 오는 인바운드 트래픽을 반드시 허용해야합니다. 

*db 안의 데이터에 관한 정보는 받지 않을겁니다.*

# amazon dynamoDb

완전 관리형 db로 데이터가 다중 az 간에 복제되므로 가용성이 높습니다. 클라우드 네이티브이며 독점 서비스입니다. nosql db입니다. 트랙잭션 지원 기능이 있습니다. 방대한 워크로드 확장이 가능하며 내부에서 분산되므로 *초당 수백만 개의 요청을 처리합니다. 또한 수조 개의 행, 수백 tb의 스토리지를 갖게 됩니다.* 
성능 또한 한 자릿수 밀리초를 자랑합니다.

유지 관리나 패치 없이도 사용가능하며 db를 프로비저닝할 필요가 없습니다.(설정, 관리, 유지관리와 같은 작업 수행 x)

용량만 설정하면 됩니다. 테이블 클랫의 종류로는 standard 클래스, ia tabel class 가 있습니다. 

aurora 와 rds 와는 달리 db가 이미 존재하는 서비스입니다. 

항목을 무한히 추가 가능합니다. 테이블에 데이터를 추가하고 항목, 즉 행을 무한히 추가하며 속성은 나중에 추가되며 null 이 가능합니다. 

하지만 큰 객체를 저장할 때는 적합하지 않습니다. 스키마를 빠르게 전개해야 할때 아주 좋습니다. 

프로비저닝된 rcu 와 wcu 만큼의 비용을 지불하는 방식입니다. 

워크로드를 예측할 수 없거나 급격히 증가하는 경우 온디맨드 모드가 좋습니다. 

*수천개의 트랜잭션을 수백만 개의 트랜잭션으로 1분 내로 확장해야 하는 애플리케이션에는 적합하지 않습니다. 이럴때에는 온디맨드 모드를 활용하는 겁니다*

# dynamo DB 고급 기능

DynamoDB Accelerator 즉 DAX는
DynamoDB를 위한 고가용성의 완전 관리형 무결절 인메모리 캐시로
DynamoDB 테이블에 읽기 작업이 많을 때
DAX 클러스터를 생성하고 데이터를 캐싱하여 읽기 혼잡을 해결합니다

DAX는 DynamoDB 앞에 있고 개별 객체 캐시와
쿼리와 스캔 캐시를 처리하는 데 유용합니다. 또한 대용량의 연산을 저장할 때 좋습니다. 

또한 스트림 처리도 가능합니다. 
Lambda 트리거와 함께 사용하면 좋고요
자체적으로 읽기를 실행하려면 DynamoDB Stream Kinesis 어댑터를 사용합니다
Kinesis Data Streams에 변경 사항을 바로 보내는 방법도 있습니다
이 스트림은 보존 기간이 1년이고
더 많은 수의 소비자 수를 갖고
데이터를 처리하는 방법이 훨씬 많습니다

![image](https://github.com/InHeeS/Certified-AWS/assets/105423951/d941e6e5-2e22-49f4-91a6-e6b5838c89b2)

globa table 의 개념이 있습니다. 여러 리전 간의 복제가 가능한 테이블입니다. 테이블 간에는 양방향 복제가 가능합니다. 

다중 활성 복제가 가능하므로 모든 리전에서 테이블을 읽고 쓸 수 있습니다. ttl을 정의하여 일정 시간 후에 삭제 되도록 하는 경우가 있습니다. 

백업 옵션으로는 지정 시간 복구를 사용하여 지속적인 백업이 가능합니다. 35일동안 지속됩니다. 시간복구도 가능합니다. 복구를 진행할때는 새로운 테이블을 생성합니다. 더 긴 백업 솝션으로는 온디맨드 백업이있고 삭제까지 보존됩니다. 

온디맨드 백업은 지연 시간에 영향을 주지 않습니다. aws backup서비스는 수명 주기 정책을 활성화 하여 리전간 백업을 복사합니다. 

모든 오류는 cloudWatch logs 에 기록됩니다. 

# example serverless api

api gateway를 사용하여 서버리스 서비스로 rest api 를 생성합니다. 클라이언트가 퍼블릭 액세스 가능합니다. http 엔드포인트 뿐만 아니라 인증부터 사용량 게획, 개발 단계 등의 기능을 제공합니다. 

websocket 프로토콜을 지원하므로 api gateway로 두가지 방법의 실시간 스트리밍이 가능합니다. 

swagger 나 open api로 내보낼 수도 있습니다. 

sdk 나 api 스펙을 생성하거나 api 읍답을 캐시할 수도 있습니다. 
온프레미스에 HTTP API가 있거나
클라우드 환경에 애플리케이션 로드 밸런서가 있을 때
API Gateway를 활용하면 속도 제한 기능
캐싱, 사용자 인증, API 키 등의 기능을 추가할 수 있습니다

api gateway를 통해 aws 서비스를 외부에 노출시킵니다. 

![image](https://github.com/InHeeS/Certified-AWS/assets/105423951/f87e7b50-e9d8-4522-9a33-a89dcca7fea7)

API Gateway 배포 방법은 세 가지이며 이를 엔드포인트 유형이라고 합니다
글로벌 클라이언트용이에요
전 세계 누구나 API Gateway에 액세스할 수 있죠
모든 요청이 CloudFront 엣지 로케이션을 통해
라우팅되므로 지연 시간이 개선됩니다
API Gateway는 여전히 생성된 리전에 위치하지만
모든 CloudFront 엣지 로케이션에서 액세스될 수 있습니다

CloudFront 엣지 로케이션을 원하지 않을 때는 리전 배포를 사용합니다
모든 사용자는 API Gateway를 생성한 리전과 같은 리전에 있어야 합니다
엣지 최적화 배포와 동일한 결과를 내며
캐싱 전략과 CloudFront 설정에
더 많은 권한을 가질 수 있습니다

끝으로 볼 API Gateway 배포 유형은
프라이빗으로 퍼블릭 배포가 아닙니다
프라이빗 API Gateway는 VPC 내에서만 액세스할 수 있어요

보안 측면에서는 api에 액세스할 때 iam 역할을 하도록 하는 겁니다. 외부 사용자에 대한 보안 초지로 Cognito 를 사용가능합니다. 

# aws step functions 

서버리스 워크프롤를 시각적을 구성할 수 있는 기능을 주로 람다 함수룰 오케스트레이션 하는데 활용합니다.

워크플로에 사람이 개입해서 승인을 해야만 진행되는 단계를 설정할 수 있습니다. 


# Amazon Cognito

Cognito는 사용자에게 웹 및 모바일 앱과 상호 작용할 수 있는 자격 증명을 부여합니다

일반적으로 이 사용자들은 AWS 계정 외부에 있습니다
모르는 사용자들에게 자격 증명을 부여해 사용자를 인식(Cognito)합니다

두 종류의 하위 서비스가 있습니다.

앱 사용자에게 가입 기능을 제공하는 Cognito 사용자 풀이 있습니다
API Gateway 및 애플리케이션 로드 밸런서와 원활히 통합됩니다

다음은 페더레이션 자격 증명이라고 불리던 Cognito 자격 증명 풀이 있는데
이는 앱에 등록된 사용자에게 임시 AWS 자격 증명을 제공해서
일부 AWS 리소스에 직접 액세스할 수 있도록 해 주고
Cognito 사용자 풀과 원활히 통합됩니다

사용자 멀티팩터 인증이 가능합니다
소셜 로그인도 가능합니다

확인이 끝나면 사용자 자격 증명으로 변환되어
백엔드의 Lambda 함수로 전달됩니다

![image](https://github.com/InHeeS/Certified-AWS/assets/105423951/2da4d2da-b008-4bfd-ad37-e5475a30fee1)

Cognito 자격 증명 풀입니다 페더레이션 자격 증명이라고도 하죠
사용자에게 자격 증명을 제공하지만
API Gateway나 애플리케이션 로드 밸런서를 통해서
애플리케이션에 액세스하지 않고
임시 AWS 자격 증명을 사용해
AWS 계정에 직접 액세스합니다

웹이나 모바일 애플리케이션의 사용자 기반을 생성할 수 있고
세분화된 액세스 제어를 위해
DynamoDB에서 행 수준 보안을 활성화할 수 있습니다

*마지막으로 Cognito 사용자 풀과 API Gateway 또는
애플리케이션 로드 밸런서를 통합할 수 있다는 점을 기억하세요*

# quiz

DynamoDB를 데이터베이스로 사용하는 전자 상거래 웹사이트가 있습니다. 곧 크리스마스 세일 기간에 들어갈 예정이며, 굉장히 인기가 높은 몇몇 항목들이 높은 조회수를 기록할 것으로 예상하고 있습니다. 안타깝게도 작년에는 높은 트래픽의 양으로 인해 ProvisionedThroughputExceededException 예외 처리 오류가 발생했었습니다. 이 오류의 재발을 방지하려면 어떻게 해야 할까요?

Answer : DAX 클러스터 생성하기 

Question 5:
DynamoDB를 데이터 저장소로 사용하는 모바일 애플리케이션을 개발했습니다. 신규 사용자가 가입한 후 환영 이메일을 자동으로 보내려고 합니다. 이를 달성하는 가장 효율적인 방법은 무엇일까요?

Answer : dynamoDb STreams 활성화하고 이메일을 보내기 위해 Lambda 함수를 호출하도록 구성 

Question 9:
CloudFront 배포를 통해 전역적으로 제공되는 애플리케이션이 있습니다. 인증 요청이 오리진까지 전달되게 하는 대신, CloudFront 엣지 로케이션에서 사용자를 인증하려 합니다. 이 요구 사항을 만족시키기 위해서는 어떤 방법을 사용해야 할까요?

Annwer : Lambda@Edge


Question 11:
AWS 서비스(예: Lambda)를 사용해 서버리스 워크플로를 구축할 수 있으며 사람의 승인을 지원하는 AWS 서비스는 무엇입니까?

Answer : AWS Step Functions
