# sts - security token service
- STS를 통해 최대 1시간까지 임시 보안 자격 증명을 얻어 AWS 리소스에 바로 액세스할 수 있고
- 첫 번째는 AssumRole이며 가장 핵심적인 계정 또는 교차 계정 내 역할을 추정하도록 합니다
- AssumeRoleWithSAML은 사용자가 SAML로 로그인 한 경우 사용자에게 임시 보안 인증을 부여합니다
- AssumeRoleWithWebIdentity은 사용자가 신분 제공자로 로그인하면 역할을 반환합니다  -> 요즘은 Cognito 자격증명 풀을 대신 사용합니다
- 다음은 GetSessoionToken인데 자세히 살펴볼 예정이며 사용자 또는 AWS 루트 계정에 MFA가 있는 경우입니다
- GetFederationToken은 연합된 사용자의 임시 자격 증명입니다
- GetCallerIdentity는 API 호출에 사용되는 IAM 사용자 또 역할의 세부 사항을 반환합니다
  - 그래서 AWS를 사용하는 동안 신원을 모르는 경우 STS GetCallerIdentity로 신원과 계정 번호 정보를 얻습니다
- DecodeAuthorizationMessage로 AWS API가 거부됐을 때 오류 메시지를 디코딩 합니다

- 그래서 역할을 추정하는 데 STS를 사용할 수 있죠
- IAM 역할에 액세스할 수 있는 원칙을 정의하고 IAM 정책으로 전체에 권한을 부여합니다
- 사용자가 같은 계정 또는 다른 계정 내 역할에 액세스하려고 합니다 이럴 때는 STS에서 AssumeRole API를 실행하면 STS는 권한이 올바른지 확인하고 임시 보안 자격 증명을 우리에게 반환해 우리가 역할을 수행하도록 합니다
- 교차 계정 액세스도 유사합니다 다른 계정에서 역할을 생성하고 자체 계정이나 타깃 계정으로 올바른 권한을 작성해 AssumeRole API를 실행해서 타깃 계정에 액세스하도록 하는데 역할을 통해 S3 버킷에 액세스한다면 S3 버킷을 계정에 액세스할 수 있는 것입니다
- 마지막으로 MFA를 통한 STS는 certified developer 시험에 출제되며 꼭 이해해야 할 부분입니다 GetSessionToken API를 사용해 STS에서 세션 토큰을 얻는 것입니다 적합한 IAM 조건의 IAM 정책이 필요합니다 그리고 IAM 역할에서aws:MultiFactorAuthPresent:true를 추가

# advanced iam
- 첫 번째는 인증 모델과 정책을 평가하는 방법입니다
- 정책에 명시적 거부와 명시적 허용이 모두 있는 경우에는 보시는 것처럼 거부로 결정합니다
- IAM 정책에서 S3 정책을 삭제했지만 EC2 인스턴스를 인증하는 S3 버킷 정책이 남아 있는 경우 계속 S3에서 작업이 가능함을 뜻합니다
- EC2 인스턴스에 연결된 IAM 역할이 있고 버킷에 읽기와 쓰기 권한을 부여하며 S3에 연결된 정책은 없습니다 -> 버킷에 쓰기나 읽기가 가능
- 통합 정책에 명시적 거부가 있고 명시적 거부가 명시적 허용보다 우선 순위가 높기 때문입니다
- EC2 인스턴스에 연결된 IAM 역할이 있고 S3 버킷 권한 같은 것은 없는 경우입니다 -> S3 버킷과 연결되어 있고 EC2 인스턴스에서 사용하는 IAM 역할에 명시적인 읽기, 쓰기 허용이 있습니다 -> 통합 정책에 의해 ec2 인스턴스는 버킷에 읽고 쓰기 가능
- IAM 정책을 생성해서 자체 홈 디렉터리에 액세스를 허용해야 합니다
- IAM에서 동적 정책을 사용해 하나만 생성하는 것입니다 그리고 ${aws:username}라는 특수한 정책 변수를 활용합니다

- 마지막으로 인라인 정책과 관리형 정책의 차이점을 살펴보겠습니다
- AWS 관리형 정책, 파워유저나 관리자를 정의하거나 작업 기능을 기반으로 할 때 유용하죠
- 고객 관리형 정책이 있습니다 여러분이 정책을 생성하고 더 세분화된 제어가 필요할 때 사용하는 것이 모범 사례입니다
-  인라인 정책입니다 정책과 법칙 간의 완전한 일대일 관계로 버전 관리나 롤백을 할 수 없고 쉽게 변경할 수 없습니다 그래서 IAM 법칙을 삭제하면 정책도 삭제됩니다
---
- IAM 역할을 생성한 람다 함수에 전달해서 Amazon S3나 ECS 태스크를 호출하도록 하거나 CodePipeline로 역할을 전달해서 다른 서비스를 호출하도록 합니다
- 다른 AWS 서비스로 역할을 전달하려면 iam:PassRole이라는 IAM 권한이 필요하고
- 구체적으로 IAM 정책은 안에 다른 service 역할이 포함되어 있습니다.

# Microsoft Active Directory(AD)와 AWS Directory Service
- 온프레미스 Microsoft 생태계 내의 모든 사용자 관리 사항이 Microsoft Active Directory에 의해 관리됩니다
- 모든 객체는 트리(tree)로 만들어지고 트리가 모여 포리스트(forest)가 됩니다

- AWS Directory Service를 이용하면 AWS에서 액티브 디렉터리를 생성할 수 있습니다
- 우선 AWS에 액티브 디렉터리를 생성하는 AWS 관리형 Microsoft AD입니다 로컬 환경에서 사용자를 관리하고 멀티팩터 인증(MFA)을 지원하죠 사용자가 따로 있는 온프레미스 AD죠
  - 반대로 온프레미스 AD 사용자가 온프레미스 AD에서 AWS 계정으로 인증을 시도해도 똑같이 계정을 찾아볼 겁니다 온프레미스 AD와 AWS AD 사이에 사용자를 공유하는 거죠
  - 혹은 'AWS Cloud에서 사용자를 관리하며 MFA를 지원하려면 AWS 관리형 AD를 사용한다' 등이요


- AD 커넥터(Connector)는 온프레미스로 리디렉트하는 디렉터리 게이트웨이 프록시로 멀티팩터 인증(MFA)을 지원합니다
  - AD 커넥터는 이름이 말해주듯이 쿼리 및 연결 요청을 온프레미스 AD로 연결하고 프록시를 보냅니다
    
- 마지막으로 Simple AD는 AD와 호환 가능한 AWS의 관리형 디렉터리입니다
  - Microsoft 디렉터리를 사용하지 않고 온프레미스 AD와 결합될 수 없어요
  - Windows를 실행하는 EC2 인스턴스를 생성할 수 있으며 Windows를 실행하는 EC2 인스턴스와 가까운 디렉터리로 활용하는 거죠
  - '온프레미스 요소가 없는 AD는 Simple AD이다'와 같은 내용이죠
